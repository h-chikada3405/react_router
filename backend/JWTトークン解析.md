# JWTの仕組みとセキュリティリスクへの対策

## JWTの仕組み

JWTは、以下の3つのセクションになっている

- ヘッダー
  - トークンのタイプとハッシュアルゴリズムを指定

- ペイロード
  - ユーザー情報や有効期限などのクレーム(claims)を含む

- 署名
  - ヘッダーとペイロードの情報を連結された文字列を、ヘッダー部で指定されたアルゴリズムと、秘密鍵を利用してハッシュ化する報を元に生成され、トークンの正当性を検証するために使用される

### 署名って？

JWTトークンが何故「安全に」利用できるのか
→ 署名があるから

「署名」とはトークンの安全性を検証するためのもので、以下のような手順で署名される
1. ヘッダー部とペイロード部をそれぞれbase64 URLでエンコードし、ドット（.）で連結する
2. 連結された文字列を、ヘッダー部で指定されたアルゴリズムと、秘密鍵を利用して署名を作成する
3. ハッシュ値をBase64 URLでエンコードしたものが署名となる

## HENNGE で採用されている暗号方式

**ES256** という暗号方式が使用されている

### ES256の仕組み

ES256は公開鍵と秘密鍵の両方を使用する楕円曲線暗号アルゴリズム

- 署名の作成
  - 秘密鍵を使用して、JWTのペイロード部分の署名を作成

- 署名の検証
  - 公開鍵を使用して、署名の正当性を検証

## 公開鍵の管理

- **公開鍵の取得**: 公開鍵自体は頻繁に変更されることはないため、最初に一度取得して、サーバー側でキャッシュしておくことが効率的

- **公開鍵の更新**: 公開鍵が変更される場合は、公開鍵のローテーションのような仕組みが必要。一般的には、公開鍵が更新される際には、その情報を提供する「公開鍵のエンドポイント」が用意されていることが多い

## JWTの解析が安全な理由

JWTトークンは、署名があることで、その信頼性や安全性が確保されている

- **署名の正当性**: JWTの署名部分は、秘密鍵を使って生成される。JWTトークンの受け手は、この秘密鍵に対応する公開鍵を使って署名の検証を行うことで、トークンが改ざんされていないことを確認できる

- **公開鍵暗号方式**: ES256は楕円曲線暗号（ECDSA）を使用していて、秘密鍵で署名した情報は、公開鍵を使わないと検証できないため、署名されたJWTトークンは、発行元が秘密鍵を持っていない限り偽造でない
→ HENNGEが秘密鍵を漏らさない限り安全

- **情報の改ざん検知**: 署名されたJWTトークンは、改ざんされると署名が無効となり、トークンが検証できなくなるため、改ざんを検知できる

### 通信を傍受してJWTを取得したら、正当なユーザーとして振る舞うことができるんじゃね？

トークンの盗聴によるリスクは、JWTに限らず、他の認証方式にも共通する問題。通信が傍受されると、悪意のある第三者が認証情報を取得し、正当なユーザーとして振る舞うことができるリスクがある

- JWTの場合、トークン自体に署名や有効期限が含まれているため、トークンが一度発行されると、それをもとにユーザーの認証が行えてしまう

- HENNGEのような外部認証サービスを利用している場合、通常はトークンやセッションIDを使って認証情報を保持し、毎回認証を行うため、セッションがサーバーに存在する形になる。しかし、この場合でもセッションハイジャックやトークンの盗聴によるリスクは存在し、通信の安全性を確保するためにHTTPSの使用やトークンの期限管理が必要

→ 外部認証サービスを利用する場合も同様にセキュリティリスクが存在する

### リスクを防ぐための対策

- **HTTPSを使用する**: 通信が常に暗号化されるようにすることで、傍受されてもいいようにする
  ※ HTTPSにはRSA暗号が使用されていて、膨大な計算資源があれば破れるかも！4096ビットの場合、突破するのに現代のスーパーコンピュータを使っても、数世代にわたる時間がかかる...現時点でほぼ最強の暗号

- **トークンの有効期限設定**: 認証情報に有効期限を設定することで、トークンの盗聴リスクを軽減できる

- **CORS**: CORSは、クロスオリジンのリクエストを制御するための仕組みで、悪意のあるサイトが正当なサイトから情報を盗み出すことを防ぐために重要。信頼できるオリジンからのみアクセスを許可できる
